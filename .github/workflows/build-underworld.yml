name: Build Underworld

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            artifact_suffix: linux-x64
          - os: windows-latest
            rid: win-x64
            artifact_suffix: win-x64
          - os: macos-latest
            rid: osx-x64
            artifact_suffix: osx-x64

    env:
      PROJECT_PATH: Underworld/Underworld.csproj
      APP_VERSION: "ERR"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # Change if you're on another major version
          dotnet-version: "9.0.x"

      - name: Read version from csproj
        id: get_version
        shell: pwsh
        run: |
          [xml]$proj = Get-Content $env:PROJECT_PATH
          $versionNode = $proj.Project.PropertyGroup.Version | Select-Object -First 1
          if ([string]::IsNullOrWhiteSpace($versionNode)) {
            Write-Error "No <Version> found in $env:PROJECT_PATH"
            exit 1
          }
          $version = $versionNode.Trim()
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "APP_VERSION=$version" >> $env:GITHUB_ENV
          echo "Using version: $version"

      - name: Restore dependencies
        run: dotnet restore Underworld/Underworld.csproj

      - name: Run tests
        run: |
          dotnet test Underworld.Tests/Underworld.Tests.csproj --configuration Release
          dotnet test Underworld.ViewModelTests/Underworld.ViewModelTests.csproj --configuration Release

      - name: Publish app
        run: dotnet publish Underworld/Underworld.csproj --configuration Release --runtime ${{ matrix.rid }} --self-contained true -p:PublishSingleFile=true -p:Version=${{ env.APP_VERSION }} -o ./publish/${{ matrix.rid }}

      # Linux: use 'zip'
      - name: Zip publish output (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd publish/${{ matrix.rid }}
          zip -r ../../Underworld-v${{ env.APP_VERSION }}-${{ matrix.artifact_suffix }}.zip .

      # macOS: use 'zip'
      - name: Zip publish output (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          cd publish/${{ matrix.rid }}
          zip -r ../../Underworld-v${{ env.APP_VERSION }}-${{ matrix.artifact_suffix }}.zip .

      # Windows: use PowerShell Compress-Archive
      - name: Zip publish output (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $zipPath = "Underworld-v${{ env.APP_VERSION }}-${{ matrix.artifact_suffix }}.zip"
          Compress-Archive -Path "publish/${{ matrix.rid }}\*" -DestinationPath $zipPath

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Underworld-v${{ env.APP_VERSION }}-${{ matrix.artifact_suffix }}
          path: Underworld-v${{ env.APP_VERSION }}-${{ matrix.artifact_suffix }}.zip
          if-no-files-found: error
